<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Apple ICNS å›¾æ ‡ç”Ÿæˆå™¨</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI';
                background: #f5f5f7;
                padding: 30px;
            }
            .container {
                max-width: 720px;
                margin: auto;
                background: #fff;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }
            h1 {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-top: 12px;
                font-weight: 600;
            }
            input[type='range'] {
                width: 100%;
            }
            canvas {
                margin-top: 20px;
                background: repeating-conic-gradient(#eee 0% 25%, #fff 0% 50%)
                    50% / 20px 20px;
                border-radius: 12px;
            }
            button {
                margin-top: 20px;
                padding: 12px 18px;
                font-size: 16px;
                border: none;
                border-radius: 10px;
                background: #007aff;
                color: #fff;
                cursor: pointer;
            }
            button:disabled {
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ Apple ICNS å›¾æ ‡ç”Ÿæˆå™¨</h1>

            <input
                title="é€‰æ‹©å›¾ç‰‡"
                type="file"
                id="fileInput"
                accept="image/*"
            />

            <label>åœ†è§’åŠå¾„ (rx)</label>
            <input
                title="åœ†è§’åŠå¾„"
                type="range"
                id="radius"
                min="0"
                max="300"
                value="250"
            />

            <label>Padding</label>
            <input
                title="Padding"
                type="range"
                id="padding"
                min="0"
                max="200"
                value="120"
            />

            <canvas id="canvas" width="1264" height="1264"></canvas>

            <button id="downloadBtn" disabled>ä¸‹è½½ ICNS</button>
        </div>

        <!-- icnsjs æµè§ˆå™¨ç‰ˆæœ¬ -->
        <script src="https://unpkg.com/icnsjs/dist/icns.js"></script>

        <script>
            const fileInput = document.getElementById('fileInput')
            const canvas = document.getElementById('canvas')
            const ctx = canvas.getContext('2d')
            const radiusInput = document.getElementById('radius')
            const paddingInput = document.getElementById('padding')
            const downloadBtn = document.getElementById('downloadBtn')

            let image = null

            function draw() {
                if (!image) return

                const padding = +paddingInput.value
                const radius = +radiusInput.value
                const size = 1024
                const total = size + padding * 2

                canvas.width = total
                canvas.height = total

                ctx.clearRect(0, 0, total, total)

                ctx.save()
                ctx.translate(padding, padding)

                // åœ†è§’è·¯å¾„
                ctx.beginPath()
                ctx.moveTo(radius, 0)
                ctx.lineTo(size - radius, 0)
                ctx.quadraticCurveTo(size, 0, size, radius)
                ctx.lineTo(size, size - radius)
                ctx.quadraticCurveTo(size, size, size - radius, size)
                ctx.lineTo(radius, size)
                ctx.quadraticCurveTo(0, size, 0, size - radius)
                ctx.lineTo(0, radius)
                ctx.quadraticCurveTo(0, 0, radius, 0)
                ctx.closePath()
                ctx.clip()

                // ç»˜åˆ¶å›¾ç‰‡ï¼ˆcontainï¼‰
                const scale = Math.min(size / image.width, size / image.height)
                const w = image.width * scale
                const h = image.height * scale
                const x = (size - w) / 2
                const y = (size - h) / 2

                ctx.drawImage(image, x, y, w, h)
                ctx.restore()

                downloadBtn.disabled = false
            }

            fileInput.onchange = (e) => {
                const file = e.target.files[0]
                if (!file) return

                const img = new Image()
                img.onload = () => {
                    image = img
                    draw()
                }
                img.src = URL.createObjectURL(file)
            }

            radiusInput.oninput = draw
            paddingInput.oninput = draw

            downloadBtn.onclick = async () => {
                // å¯¼å‡º PNG
                const pngBlob = await new Promise((res) =>
                    canvas.toBlob(res, 'image/png')
                )

                const arrayBuffer = await pngBlob.arrayBuffer()

                // ç”Ÿæˆ ICNSï¼ˆ1024 è¶³å¤Ÿï¼‰
                const icns = new Icns.Icns()
                icns.append(Icns.Image.fromPNG(arrayBuffer, 1024))

                const icnsBlob = new Blob([icns.toBuffer()], {
                    type: 'image/icns',
                })

                const a = document.createElement('a')
                a.href = URL.createObjectURL(icnsBlob)
                a.download = 'icon.icns'
                a.click()
            }
        </script>
    </body>
</html>
